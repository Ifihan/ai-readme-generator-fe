<app-page-layout [showBackButton]="true">
  <div class="history-container">
    <div class="history-header">
      <h2>README Generation History</h2>
      <p class="history-description">View your past README generations and access their repositories.</p>
    </div>

    <div *ngIf="loading" class="loading-message">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="animate-spin">
        <path d="M12 2V6M12 18V22M6 12H2M22 12H18M19.07 4.93L16.24 7.76M7.76 16.24L4.93 19.07M19.07 19.07L16.24 16.24M7.76 7.76L4.93 4.93"
          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Loading history...</span>
    </div>

    <div *ngIf="error" class="error">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 8v5M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"
          stroke="currentColor" stroke-width="2"/>
      </svg>
      {{ error }}
    </div>

    <div *ngIf="!loading && !error" class="history-content">
      <div *ngIf="entries.length === 0" class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h3>No README History</h3>
        <p>You haven't generated any READMEs yet. Start by going to the dashboard and generating your first README!</p>
        <a routerLink="/dashboard" class="btn-primary">Go to Dashboard</a>
      </div>

      <div *ngIf="entries.length > 0" class="history-list">
        <div *ngFor="let entry of entries" class="history-card" 
          [ngClass]="{'removing': entry.isDeletedFromView}"
          [ngStyle]="{'opacity': entry.isDisabled ? 0.3 : 1}"
        >
          <div class="card-header" style="position: relative;">
            <!-- Delete Button -->
            <button
              class="delete-btn"
              (click)="deleteEntry(entry)"
              type="button"
              title="Delete entry"
              style="position: absolute; top: 8px; right: 8px; background: transparent; border: none; cursor: pointer; padding: 0;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <rect x="5" y="6" width="14" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
            <div class="repo-info">
              <div class="repo-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="repo-icon">
                  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3 class="repo-name" (click)="openRepository(entry.repository_url)" title="Open repository">
                  {{ entry.repository_name }}
                </h3>
              </div>
              <a [href]="'https://github.com/' + entry.repository_url" target="_blank" rel="noopener noreferrer" class="repo-link">
                {{ entry.repository_url }}
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            </div>
            
            <!-- <div class="type-badge" [class.badge-new]="entry.generation_type === 'new'" [class.badge-update]="entry.generation_type === 'update'">
              {{ entry.generation_type === 'new' ? 'New' : 'Update' }}
            </div> -->
          </div>

          <div class="card-body">
            <div class="user-info">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>{{ entry.username }}</span>
            </div>

            <div class="sections-wrapper">
              <div class="sections-header">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="sections-label">{{ entry.sections_generated.length }} Section{{ entry.sections_generated.length !== 1 ? 's' : '' }}</span>
              </div>
              <div class="section-tags">
                <span *ngFor="let section of entry.sections_generated" class="section-tag">{{ section }}</span>
              </div>
            </div>
          </div>

          <div class="card-footer">
            <div class="meta-items">
              <div class="meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>{{ formatDate(entry.created_at) }}</span>
              </div>
              <div class="meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9l-7-7z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M13 2v7h7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>{{ formatFileSize(entry.file_size) }}</span>
              </div>
            </div>
            
            <div>
              <button class="view-content-btn" (click)="toggleContent(entry)" type="button" style="margin-right: 10px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                {{ entry.showContent ? 'Hide' : 'View' }} Content
              </button>

              <button class="view-content-btn" (click)="downloadContent(entry.content, entry.repository_name)" type="button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Download README
              </button>
            </div>
          </div>
          
          <div class="content-preview" *ngIf="entry.showContent">
            <div class="content-header">
              <h4>README Content</h4>
              <button class="copy-btn" (click)="copyContent(entry.content)" type="button" title="Copy to clipboard">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Copy
              </button>
            </div>
            <pre class="content-text">{{ cleanMarkdownContent(entry.content) }}</pre>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div *ngIf="totalPages > 1" class="pagination">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="previousPage()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <span class="page-info">
          Page {{ currentPage }} of {{ totalPages }} ({{ totalCount }} total)
        </span>

        <button
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="nextPage()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</app-page-layout>
